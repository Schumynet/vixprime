<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VixPrime</title>

    <!-- Video.js -->
    <link href="https://vjs.zencdn.net/8.16.1/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.16.1/video.min.js"></script>

    <!-- HLS quality selector plugin -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/videojs-hls-quality-selector@2.0.0/dist/videojs-hls-quality-selector.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/videojs-hls-quality-selector@2.0.0/dist/videojs-hls-quality-selector.min.js"></script>

    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { background: #141414; color: #fff; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; }
      header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 70%, transparent 100%); backdrop-filter: blur(10px); padding: 1rem 4%; display:flex; justify-content:space-between; align-items:center; gap:2rem; transition: background 0.3s ease; }
      header.scrolled { background: rgba(0,0,0,0.95); }
      .logo { font-size: 2rem; font-weight: 700; color: #e50914; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); }
      .header-controls { display:flex; align-items:center; gap:1rem; flex:1; justify-content:flex-end; }
      .search-container { position:relative; flex:0 1 350px; }
      #search { padding:12px 20px; font-size:1rem; width:100%; border:2px solid rgba(255,255,255,0.18); border-radius:25px; background:rgba(0,0,0,0.7); color:#fff; outline:none; transition: all 0.25s ease; }
      #search:focus { border-color:#e50914; box-shadow:0 0 20px rgba(229,9,20,0.18); transform:scale(1.01); }
      .cors-selector { position:relative; }
      .cors-label { font-size:0.85rem; color:rgba(255,255,255,0.7); margin-bottom:4px; display:block; }
      #cors-select { padding:10px 35px 10px 15px; font-size:0.95rem; min-width:180px; border:2px solid rgba(255,255,255,0.12); border-radius:20px; background:rgba(0,0,0,0.7); color:#fff; cursor:pointer; outline:none; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; }
      main { margin-top: 80px; }

      /* HERO: original style with background image + overlay */
      .hero {
        height: 70vh;
        background: url('https://image.tmdb.org/t/p/original/9Gtg2DzBhmYamXBS1hKAhiwbBKS.jpg') center center / cover no-repeat;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin-bottom: 3rem;
        position: relative;
      }

      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(20, 20, 20, 0.9), rgba(20, 20, 20, 0.3));
        z-index: 1;
      }

      .hero-content {
        position: relative;
        z-index: 2;
      }

      .hero-content h1 { font-size:4rem; margin-bottom:1rem; text-shadow:3px 3px 6px rgba(0,0,0,0.6); }
      .hero-content p { font-size:1.25rem; opacity:0.95; max-width:700px; margin:0 auto; }

      section { margin:3rem 0; }
      section h2 { font-size:2rem; margin-bottom:1.25rem; padding-left:4%; position:relative; }
      section h2::before { content:""; position:absolute; left:4%; bottom:-6px; width:60px; height:3px; background:#e50914; }
      .carousel-container { position:relative; margin:0 4%; }
      .carousel { display:flex; overflow-x:auto; gap:1rem; scroll-snap-type:x mandatory; scrollbar-width:none; -ms-overflow-style:none; scroll-behavior:smooth; padding:0 50px; }
      .carousel::-webkit-scrollbar { display:none; }
      .carousel-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.8); color:#fff; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem; z-index:10; display:flex; align-items:center; justify-content:center; transition:all 0.25s ease; }
      .carousel-btn.prev { left:5px; } .carousel-btn.next { right:5px; }
      .carousel-btn:hover { background:rgba(229,9,20,0.95); transform:translateY(-50%) scale(1.05); box-shadow:0 6px 18px rgba(229,9,20,0.2); }
      .card { min-width:200px; cursor:pointer; transition:all 0.25s ease; scroll-snap-align:start; position:relative; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
      .card img { width:100%; height:300px; object-fit:cover; display:block; border-radius:12px; }
      .card-title { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.95)); padding:1.6rem 1rem 1rem; font-weight:600; text-align:center; }
      .badge { position:absolute; top:10px; left:10px; background:rgba(229,9,20,0.95); color:#fff; padding:6px 8px; border-radius:6px; font-size:0.75rem; font-weight:700; z-index:12; box-shadow:0 4px 12px rgba(0,0,0,0.35); }
      #home { display:block; } #results { display:none; padding:2rem 4%; } #player { display:none; padding:2rem 4%; }
      .player-header { margin-bottom:1.5rem; } .back-btn { background:rgba(229,9,20,0.95); color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; transition:all 0.2s ease; }
      .player-info { margin-bottom:1.5rem; } .player-info h1 { font-size:2.2rem; margin-bottom:0.6rem; color:#fff; }
      .meta { display:flex; gap:1rem; margin-bottom:0.8rem; font-size:0.95rem; opacity:0.85; }
      .overview { line-height:1.6; opacity:0.95; max-width:900px; }
      .player-content { display:grid; grid-template-columns:1fr 350px; gap:1.5rem; align-items:start; }
      .video-container { position:relative; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.5); min-height:220px; }
      .select-episode-warning { position:absolute; inset:0; background:linear-gradient(135deg, rgba(20,20,20,0.95), rgba(10,10,10,0.95)); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:15; border-radius:12px; padding:2rem; text-align:center; }
      .select-episode-warning .icon { font-size:4.5rem; margin-bottom:1rem; color:#e50914; animation:pulse 2s ease-in-out infinite; }
      @keyframes pulse { 0%,100%{opacity:1; transform:scale(1);} 50%{opacity:0.75; transform:scale(1.06);} }
      .video-js { width:100%; height:auto; aspect-ratio:16/9; font-family:inherit; }

      /* Responsive Video.js controls: scale icons and layout to avoid hiding */
      .video-js .vjs-control-bar {
  flex-wrap: wrap;
  row-gap: 6px;
  padding: 8px;
}

      .video-js .vjs-control {
        font-size: clamp(12px, 1.6vw, 18px);
        min-width: 36px;
      }

      .video-js .vjs-icon-placeholder:before {
        font-size: clamp(14px, 2.2vw, 24px);
      }

      .video-js .vjs-control.vjs-button {
        padding: 6px;
      }

      .video-js .vjs-playback-rate,
      .video-js .vjs-volume-panel,
      .video-js .vjs-fullscreen-control {
        min-width: 36px;
      }

      .video-js .vjs-control-bar .vjs-time-control {
        min-width: 60px;
      }

      /* Small screens adjustments */
      @media (max-width: 480px) {
        .video-js .vjs-control-bar {
          padding: 6px;
        }
        .video-js .vjs-control {
          font-size: 13px;
          min-width: 30px;
        }
        .video-js .vjs-icon-placeholder:before {
          font-size: 16px;
        }
      }

      .episode-selector { background:rgba(255,255,255,0.06); border-radius:12px; padding:1.25rem; backdrop-filter:blur(8px); height:fit-content; }
      .episode-selector h3 { margin-bottom:0.75rem; color:#e50914; }
      .season-selector { margin-bottom:1rem; }
      .season-selector label { display:block; margin-bottom:0.5rem; font-weight:600; }
      .season-selector select { width:100%; padding:10px; border:2px solid rgba(255,255,255,0.08); border-radius:8px; background:rgba(0,0,0,0.7); color:#fff; outline:none; }
      .episodes-list { max-height:420px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:#e50914 transparent; }
      .episode-item { padding:10px; margin-bottom:8px; background:rgba(255,255,255,0.03); border-radius:8px; cursor:pointer; transition:all 0.18s ease; border:2px solid transparent; }
      .episode-item:hover { background:rgba(229,9,20,0.08); border-color:#e50914; }
      .episode-item.active { background:rgba(229,9,20,0.14); border-color:#e50914; }
      .episode-number { font-weight:700; color:#e50914; margin-bottom:4px; }
      .episode-title { font-size:0.95rem; opacity:0.95; }
      .loading-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:25; border-radius:12px; }
      .loading { width:48px; height:48px; border:5px solid rgba(255,255,255,0.2); border-radius:50%; border-top-color:#e50914; animation:spin 1s linear infinite; margin-bottom:0.8rem; }
      @keyframes spin { to { transform:rotate(360deg); } }
      .loading-text { color:#fff; opacity:0.95; }
      .error-message { background:rgba(229,9,20,0.12); border:2px solid #e50914; color:#fff; padding:1rem; border-radius:8px; margin:1rem 0; text-align:center; }
      @media (max-width: 900px) { .player-content { grid-template-columns:1fr; } .card { min-width:150px; } header { flex-direction:column; gap:0.75rem; } .header-controls { width:100%; justify-content:center; flex-wrap:wrap; } .search-container { flex:1 1 100%; } #cors-select { min-width:140px; } }
    </style>
  </head>
  <body>
    <header id="header">
      <div class="logo">VixPrime</div>
      <div class="header-controls">
        <div class="cors-selector">
          <label class="cors-label" for="cors-select">üåê CORS Proxy</label>
          <select id="cors-select"></select>
        </div>
        <div class="search-container">
          <input id="search" type="text" placeholder="üîç Cerca film, serie TV..." />
        </div>
      </div>
    </header>

    <main>
      <div id="home">
        <section class="hero">
          <div class="hero-content">
            <h1>Benvenuto su VixPrime</h1>
            <p>Scopri migliaia di film e serie TV in streaming</p>
          </div>
        </section>

        <section id="trending">
          <h2>üî• Trending</h2>
          <div class="carousel-container">
            <button class="carousel-btn prev" onclick="scrollCarousel('trending', -1)">‚Äπ</button>
            <div class="carousel"></div>
            <button class="carousel-btn next" onclick="scrollCarousel('trending', 1)">‚Ä∫</button>
          </div>
        </section>

        <section id="nowPlaying">
          <h2>üé¨ Ultimi Film</h2>
          <div class="carousel-container">
            <button class="carousel-btn prev" onclick="scrollCarousel('nowPlaying', -1)">‚Äπ</button>
            <div class="carousel"></div>
            <button class="carousel-btn next" onclick="scrollCarousel('nowPlaying', 1)">‚Ä∫</button>
          </div>
        </section>

        <section id="popularMovies">
          <h2>‚≠ê Film Popolari</h2>
          <div class="carousel-container">
            <button class="carousel-btn prev" onclick="scrollCarousel('popularMovies', -1)">‚Äπ</button>
            <div class="carousel"></div>
            <button class="carousel-btn next" onclick="scrollCarousel('popularMovies', 1)">‚Ä∫</button>
          </div>
        </section>

        <section id="onTheAir">
          <h2>üì∫ Ultime Serie</h2>
          <div class="carousel-container">
            <button class="carousel-btn prev" onclick="scrollCarousel('onTheAir', -1)">‚Äπ</button>
            <div class="carousel"></div>
            <button class="carousel-btn next" onclick="scrollCarousel('onTheAir', 1)">‚Ä∫</button>
          </div>
        </section>

        <section id="popularTV">
          <h2>üèÜ Serie Popolari</h2>
          <div class="carousel-container">
            <button class="carousel-btn prev" onclick="scrollCarousel('popularTV', -1)">‚Äπ</button>
            <div class="carousel"></div>
            <button class="carousel-btn next" onclick="scrollCarousel('popularTV', 1)">‚Ä∫</button>
          </div>
        </section>
      </div>

      <div id="results"></div>

      <div id="player">
        <div class="player-header">
          <button class="back-btn" onclick="goBack()">‚Üê Torna indietro</button>
        </div>

        <div class="player-info" id="player-info">
          <h1 id="player-title"></h1>
          <div class="meta" id="player-meta"></div>
          <div class="overview" id="player-overview"></div>
        </div>

        <div class="player-content">
          <div class="video-container">
            <div id="episode-warning" class="select-episode-warning" style="display:none;">
              <div class="icon">üì∫</div>
              <h3>Seleziona un episodio</h3>
              <p>Scegli una stagione e un episodio dalla lista a destra per iniziare la riproduzione</p>
            </div>

            <!-- video element will be inserted here dynamically -->
            <div id="loading-overlay" class="loading-overlay" style="display:none;">
              <div class="loading"></div>
              <div class="loading-text">Caricamento stream...</div>
            </div>
          </div>

          <div class="episode-selector" id="episode-selector" style="display:none;">
            <h3>Seleziona episodio</h3>
            <div class="season-selector">
              <label for="season-select">Stagione:</label>
              <select id="season-select"></select>
            </div>
            <div class="episodes-list" id="episodes-list"></div>
          </div>
        </div>
      </div>
    </main>

    <script>
      /* Config & Globals */
      const API_KEY = "8265bd1679663a7ea12ac168da84d2e8";
      const VIXSRC_URL = "vixsrc.to";
      const CORS_PROXIES_REQUIRING_ENCODING = [""];
      const CORS_LIST = ["cors-anywhere.com/", "corsproxy.io/", "api.allorigins.win/raw?url=", ...CORS_PROXIES_REQUIRING_ENCODING];
      let CORS = "corsproxy.io/";

      const endpoints = {
        trending: `trending/all/week`,
        nowPlaying: `movie/now_playing`,
        popularMovies: `movie/popular`,
        onTheAir: `tv/on_the_air`,
        popularTV: `tv/popular`,
      };

      // Hercai custom data
      const HERCAI_TMDB_ID = 87623;
      const HERCAI_EPISODES_PER_SEASON = [44, 100, 86];
      const HERCAI_TOTAL_SEASONS = HERCAI_EPISODES_PER_SEASON.length;

      let currentItem = null;
      let currentSeasons = [];
      let player = null;
      let baseStreamUrl = "";
      let requestHookInstalled = false;
      let searchTimeout;

      /* Utility functions */
      function extractBaseUrl(url) {
        try {
          const selectedCORS = document.getElementById("cors-select")?.value || CORS;
          let cleanUrl = url;
          if (url.includes(selectedCORS)) cleanUrl = url.split(selectedCORS)[1];
          const urlObj = new URL(cleanUrl);
          return `${urlObj.protocol}//${urlObj.host}`;
        } catch (e) {
          console.error("Error extracting base URL:", e);
          return "";
        }
      }

      function resolveUrl(url, baseUrl = "https://vixsrc.to") {
        if (!url) return url;
        if (url.startsWith("http://") || url.startsWith("https://")) return url;
        if (url.startsWith("/")) return baseUrl + url;
        return baseUrl + "/" + url;
      }

      function applyCorsProxy(url) {
        const selectedCORS = document.getElementById("cors-select")?.value || CORS;
        const requiresEncoding = CORS_PROXIES_REQUIRING_ENCODING.some((proxy) => selectedCORS === proxy);
        let cleanUrl = url;
        if (url.includes(selectedCORS)) {
          cleanUrl = requiresEncoding ? decodeURIComponent(url.split(selectedCORS)[1]) : url.split(selectedCORS)[1];
        }
        if (!cleanUrl.startsWith("http://") && !cleanUrl.startsWith("https://")) {
          cleanUrl = resolveUrl(cleanUrl);
        }
        if (cleanUrl.startsWith("data:") || cleanUrl.startsWith("blob:") || !cleanUrl.startsWith("https://vixsrc.to")) {
          return url;
        }
        return requiresEncoding ? `https://${selectedCORS}${encodeURIComponent(cleanUrl)}` : `https://${selectedCORS}${cleanUrl}`;
      }

      const xhrRequestHook = (options) => {
        const originalUri = options.uri;
        options.uri = applyCorsProxy(originalUri);
        return options;
      };

      function setupVideoJsXhrHook() {
        if (typeof videojs === "undefined" || !videojs.Vhs) return;
        if (requestHookInstalled) return;
        videojs.Vhs.xhr.onRequest(xhrRequestHook);
        requestHookInstalled = true;
      }

      function removeVideoJsXhrHook() {
        if (typeof videojs !== "undefined" && videojs.Vhs && requestHookInstalled) {
          videojs.Vhs.xhr.offRequest(xhrRequestHook);
          requestHookInstalled = false;
        }
      }

      window.addEventListener("scroll", () => {
        const header = document.getElementById("header");
        header.classList.toggle("scrolled", window.scrollY > 50);
      });

      /* TMDb helpers */
      async function fetchList(type) {
        const res = await fetch(`https://api.themoviedb.org/3/${endpoints[type]}?api_key=${API_KEY}&language=it-IT`);
        const j = await res.json();
        return j.results || [];
      }

      async function fetchTVDetails(tvId) {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=${API_KEY}&language=it-IT`);
        return await res.json();
      }

      async function fetchMovieDetails(movieId) {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${API_KEY}&language=it-IT`);
        return await res.json();
      }

      async function fetchTVSeasons(tvId) {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=${API_KEY}&language=it-IT`);
        const j = await res.json();
        return j.seasons || [];
      }

      async function fetchEpisodes(tvId, seasonNum) {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNum}?api_key=${API_KEY}&language=it-IT`);
        const j = await res.json();
        return j.episodes || [];
      }

      /* UI helpers & cards */
      function createCard(item) {
        const card = document.createElement("div");
        card.className = "card";

        const poster = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : "https://via.placeholder.com/200x300?text=No+Image";
        const title = item.title || item.name || "Senza titolo";
        const isHercai = (title || "").toLowerCase().includes("hercai") || item.id === HERCAI_TMDB_ID;

        card.innerHTML = `
          <img src="${poster}" alt="${title}">
          ${isHercai ? '<div class="badge">Personalizzato</div>' : ''}
          <div class="card-title">${title}</div>
        `;

        card.addEventListener("click", async () => {
          card.classList.add("clicked");
          setTimeout(async () => {
            if (isHercai) {
              // Open Hercai as TV explicitly
              const tmdbItem = {
                id: HERCAI_TMDB_ID,
                name: "Hercai",
                media_type: "tv",
                isHercaiCustom: true,
                overview: item.overview || undefined
              };
              await openPlayer(tmdbItem);
              return;
            }

            // Preserve media_type when present (search results include it)
            const payload = {
              ...item,
              media_type: item.media_type || (item.title ? "movie" : "tv")
            };
            await openPlayer(payload);
          }, 220);
        });

        return card;
      }

      /* Open player: robust media type handling (movie vs tv) */
      async function openPlayer(item) {
        currentItem = item;
        document.getElementById("home").style.display = "none";
        document.getElementById("results").style.display = "none";
        document.getElementById("player").style.display = "block";

        // Determine media type reliably
        let mediaType = item.media_type;
        if (!mediaType) {
          if (item.isHercaiCustom) mediaType = "tv";
          else mediaType = item.title ? "movie" : "tv";
        }

        // Fetch proper details based on media type
        let details = item;
        try {
          if (mediaType === "tv") {
            details = await fetchTVDetails(item.id);
          } else if (mediaType === "movie") {
            details = await fetchMovieDetails(item.id);
          }
        } catch (e) {
          console.warn("Errore fetching details:", e);
          details = { ...item };
        }

        const title = details.title || details.name || item.title || item.name || "Senza titolo";
        const releaseDate = details.release_date || details.first_air_date || "N/A";

        document.getElementById("player-title").textContent = title;
        document.getElementById("player-meta").innerHTML = `Data: ${releaseDate}`;
        document.getElementById("player-overview").textContent = details.overview || item.overview || "...";

        if (mediaType === "tv") {
          document.getElementById("episode-warning").style.display = "flex";
          // If this is the custom Hercai card, pass the flag so seasons/episodes are built from custom data
          await loadTVSeasons(details.id || item.id, !!item.isHercaiCustom);
        } else {
          document.getElementById("episode-warning").style.display = "none";
          document.getElementById("episode-selector").style.display = "none";
          await loadVideo(true, details.id || item.id);
        }

        window.scrollTo(0, 0);
      }

      /* Load seasons (normal TMDb or custom Hercai) */
      async function loadTVSeasons(tvId, isHercai = false) {
        const selector = document.getElementById("season-select");
        selector.innerHTML = "";

        if (isHercai) {
          // Use custom seasons/episodes
          currentSeasons = HERCAI_EPISODES_PER_SEASON.map((count, idx) => ({ season_number: idx + 1, episode_count: count }));
          currentSeasons.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s.season_number;
            opt.textContent = `Stagione ${s.season_number}`;
            selector.appendChild(opt);
          });
          selector.onchange = () => loadEpisodes(tvId, parseInt(selector.value, 10), true);
          document.getElementById("episode-selector").style.display = "block";
          await loadEpisodes(tvId, 1, true);
          return;
        }

        // Default TMDb logic
        const seasons = await fetchTVSeasons(tvId);
        currentSeasons = seasons.filter((s) => s.season_number > 0);
        currentSeasons.forEach((season) => {
          const opt = document.createElement("option");
          opt.value = season.season_number;
          opt.textContent = `Stagione ${season.season_number}`;
          selector.appendChild(opt);
        });
        selector.onchange = () => loadEpisodes(tvId, parseInt(selector.value, 10));
        document.getElementById("episode-selector").style.display = "block";
        if (currentSeasons.length > 0) await loadEpisodes(tvId, currentSeasons[0].season_number);
      }

      /* Load episodes (normal TMDb or custom Hercai) */
      async function loadEpisodes(tvId, seasonNum, isHercai = false) {
        const container = document.getElementById("episodes-list");
        container.innerHTML = "";

        let episodes = [];
        if (isHercai) {
          const count = HERCAI_EPISODES_PER_SEASON[seasonNum - 1] || 0;
          episodes = Array.from({ length: count }, (_, i) => ({ episode_number: i + 1, name: `Episodio ${i + 1}` }));
        } else {
          episodes = await fetchEpisodes(tvId, seasonNum);
        }

        episodes.forEach((ep) => {
          const div = document.createElement("div");
          div.className = "episode-item";
          div.innerHTML = `<div class="episode-number">Episodio ${ep.episode_number}</div><div class="episode-title">${ep.name || "Senza titolo"}</div>`;
          div.onclick = async () => {
            document.querySelectorAll(".episode-item").forEach((e) => e.classList.remove("active"));
            div.classList.add("active");
            document.getElementById("episode-warning").style.display = "none";
            document.getElementById("episode-selector").style.display = "none";
            await loadVideo(false, tvId, seasonNum, ep.episode_number);
          };
          container.appendChild(div);
        });
      }

      /* VixSrc parsing & stream extraction */
      async function getDirectStream(tmdbId, isMovie, season = null, episode = null) {
        try {
          showLoading(true, "Connessione al server...");
          let vixsrcUrl = `https://${VIXSRC_URL}/${isMovie ? "movie" : "tv"}/${tmdbId}`;
          if (!isMovie && season !== null && episode !== null) vixsrcUrl += `/${season}/${episode}`;

          showLoading(true, "Recupero pagina vixsrc...");
          const response = await fetch(applyCorsProxy(vixsrcUrl));
          const html = await response.text();

          const playlistParamsRegex = /window\.masterPlaylist[^:]+params:[^{]+({[^<]+?})/;
          const playlistParamsMatch = html.match(playlistParamsRegex);
          if (!playlistParamsMatch) throw new Error("Impossibile trovare i parametri della playlist");

          let playlistParamsStr = playlistParamsMatch[1].replace(/'/g, '"').replace(/\s+/g, "").replace(/\n/g, "").replace(/\\n/g, "").replace(",}", "}");
          let playlistParams;
          try { playlistParams = JSON.parse(playlistParamsStr); } catch (e) { throw new Error("Errore nel parsing dei parametri: " + e.message); }

          const playlistUrlRegex = /window\.masterPlaylist\s*=\s*\{[\s\S]*?url:\s*'([^']+)'/;
          const playlistUrlMatch = html.match(playlistUrlRegex);
          if (!playlistUrlMatch) throw new Error("Impossibile trovare l'URL della playlist");

          const playlistUrl = playlistUrlMatch[1];
          const canPlayFHDRegex = /window\.canPlayFHD\s+?=\s+?(\w+)/;
          const canPlayFHDMatch = html.match(canPlayFHDRegex);
          const canPlayFHD = canPlayFHDMatch && canPlayFHDMatch[1] === "true";

          const hasQuery = /\?[^#]+/.test(playlistUrl);
          const separator = hasQuery ? "&" : "?";
          const m3u8Url = playlistUrl + separator + "expires=" + playlistParams.expires + "&token=" + playlistParams.token + (canPlayFHD ? "&h=1" : "");

          baseStreamUrl = extractBaseUrl(m3u8Url);
          showLoading(false);
          return { iframeUrl: vixsrcUrl, m3u8Url };
        } catch (error) {
          console.error("Error in getDirectStream:", error);
          showLoading(false);
          showError("Errore durante l'estrazione dello stream", error.message || "");
          return null;
        }
      }

      /* Keyboard shortcuts & feedback */
      function setupKeyboardShortcuts() {
        document.removeEventListener("keydown", handleKeyboardShortcuts);
        document.addEventListener("keydown", handleKeyboardShortcuts);
      }

      function handleKeyboardShortcuts(event) {
        if (!player || !player.readyState) return;
        if (event.target.tagName === "INPUT" || event.target.tagName === "TEXTAREA" || event.target.isContentEditable) return;
        const key = event.key.toLowerCase();
        switch (key) {
          case " ":
            event.preventDefault();
            if (player.paused()) player.play(); else player.pause();
            break;
          case "arrowright":
            event.preventDefault();
            player.currentTime(Math.min(player.currentTime() + 5, player.duration()));
            showSeekFeedback("+5s");
            break;
          case "arrowleft":
            event.preventDefault();
            player.currentTime(Math.max(player.currentTime() - 5, 0));
            showSeekFeedback("-5s");
            break;
          case "arrowup":
            event.preventDefault();
            player.volume(Math.min(player.volume() + 0.1, 1));
            showVolumeFeedback(Math.round(player.volume() * 100));
            break;
          case "arrowdown":
            event.preventDefault();
            player.volume(Math.max(player.volume() - 0.1, 0));
            showVolumeFeedback(Math.round(player.volume() * 100));
            break;
          case "f":
            event.preventDefault();
            if (player.isFullscreen && player.isFullscreen()) player.exitFullscreen(); else if (player.requestFullscreen) player.requestFullscreen();
            break;
          case "m":
            event.preventDefault();
            player.muted(!player.muted());
            break;
        }
      }

      function showSeekFeedback(text) {
        const feedback = document.createElement("div");
        feedback.className = "keyboard-feedback";
        feedback.textContent = text;
        feedback.style.cssText = "position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#e50914;padding:14px 26px;border-radius:8px;font-size:1.6rem;font-weight:700;z-index:100;pointer-events:none;animation:feedbackFade 0.8s ease;";
        document.querySelector(".video-container").appendChild(feedback);
        setTimeout(() => feedback.remove(), 800);
      }

      function showVolumeFeedback(volumePercent) {
        let volumeDisplay = document.getElementById("volume-feedback");
        if (!volumeDisplay) {
          volumeDisplay = document.createElement("div");
          volumeDisplay.id = "volume-feedback";
          volumeDisplay.style.cssText = "position:absolute;top:50%;right:40px;transform:translateY(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:10px 16px;border-radius:8px;font-size:1rem;font-weight:700;z-index:100;pointer-events:none;display:flex;align-items:center;gap:8px;";
          document.querySelector(".video-container").appendChild(volumeDisplay);
        }
        volumeDisplay.innerHTML = `üîä ${volumePercent}%`;
        volumeDisplay.style.opacity = "1";
        if (volumeDisplay.timeoutId) clearTimeout(volumeDisplay.timeoutId);
        volumeDisplay.timeoutId = setTimeout(() => { volumeDisplay.style.opacity = "0"; }, 1000);
      }

      const feedbackStyles = document.createElement("style");
      feedbackStyles.textContent = `
        @keyframes feedbackFade { 0%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}20%{opacity:1;transform:translate(-50%,-50%) scale(1);}80%{opacity:1;}100%{opacity:0;transform:translate(-50%,-50%) scale(0.9);} }
        #volume-feedback { transition: opacity 0.25s ease; }
      `;
      document.head.appendChild(feedbackStyles);

      /* Player loader */
      async function loadVideo(isMovie, id, season = null, episode = null) {
        showLoading(true);
        try {
          setupVideoJsXhrHook();
          if (player) { try { player.dispose(); } catch (e) { console.warn(e); } player = null; }

          const videoContainer = document.querySelector(".video-container");
          const oldVideo = document.getElementById("player-video");
          if (oldVideo) try { oldVideo.remove(); } catch (e) { console.warn(e); }

          const newVideo = document.createElement("video");
          newVideo.id = "player-video";
          newVideo.className = "video-js vjs-theme-vixflix vjs-big-play-centered";
          newVideo.setAttribute("controls", "");
          newVideo.setAttribute("preload", "auto");
          newVideo.setAttribute("playsinline", "");
          newVideo.setAttribute("crossorigin", "anonymous");

          const loadingOverlay = document.getElementById("loading-overlay");
          videoContainer.insertBefore(newVideo, loadingOverlay);

          const streamData = await getDirectStream(id, isMovie, season, episode);
          if (!streamData || !streamData.m3u8Url) throw new Error("Impossibile ottenere l'URL dello stream");

          const proxiedM3u8Url = applyCorsProxy(streamData.m3u8Url);

          player = videojs("player-video", {
            controls: true,
            fluid: true,
            aspectRatio: "16:9",
            playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
            html5: { vhs: { overrideNative: true, bandwidth: 1000000 } },
            controlBar: {
              children: [
                "playToggle","volumePanel","currentTimeDisplay","timeDivider","durationDisplay",
                "progressControl","remainingTimeDisplay","playbackRateMenuButton","chaptersButton",
                "descriptionsButton","subsCapsButton","audioTrackButton","qualitySelector","fullscreenToggle"
              ]
            }
          });

          player.src({ src: proxiedM3u8Url, type: "application/x-mpegURL" });

          if (typeof player.hlsQualitySelector === "function") {
            try { player.hlsQualitySelector(); } catch (e) { console.warn(e); }
          }

          player.ready(function () {
            setupKeyboardShortcuts();
            showLoading(false);
            player.play().catch(() => {});
          });

          player.on("error", function () { showError("Errore durante il caricamento del video"); });
        } catch (err) {
          console.error("Error loading video:", err);
          showError("Impossibile caricare il video. Riprova pi√π tardi.");
        }
      }

      function showLoading(show, message = "Caricamento stream...") {
        const overlay = document.getElementById("loading-overlay");
        overlay.style.display = show ? "flex" : "none";
        overlay.querySelector(".loading-text").textContent = message;
      }

      function showError(message, details = "") {
        showLoading(false);
        const container = document.querySelector(".video-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerHTML = `<h3>‚ö†Ô∏è Errore</h3><p>${message}</p>${details ? `<p style="font-size:0.9em;opacity:0.8;margin-top:0.5rem;">${details}</p>` : ""}`;
        container.appendChild(errorDiv);
        setTimeout(() => { try { errorDiv.remove(); } catch (e) {} }, 5000);
      }

      function goBack() {
        if (player) { try { player.dispose(); } catch (e) { console.warn(e); } player = null; }
        document.getElementById("player").style.display = "none";
        document.getElementById("home").style.display = "block";
        document.getElementById("episode-selector").style.display = "none";
        document.getElementById("episode-warning").style.display = "flex";
      }

      function scrollCarousel(sectionId, direction) {
        const section = document.getElementById(sectionId);
        const carousel = section.querySelector(".carousel");
        const scrollAmount = carousel.clientWidth * 0.8;
        carousel.scrollBy({ left: direction * scrollAmount, behavior: "smooth" });
      }

      /* Search */
      async function performSearch(query) {
        const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&language=it-IT&query=${encodeURIComponent(query)}`);
        const data = await res.json();
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = '<h2>Risultati della ricerca</h2><div class="carousel"></div>';
        const carousel = resultsDiv.querySelector(".carousel");
        (data.results || []).filter((item) => item.media_type !== "person" && (item.poster_path || item.name || item.title)).forEach((item) => {
          carousel.appendChild(createCard(item));
        });

        document.getElementById("home").style.display = "none";
        document.getElementById("player").style.display = "none";
        resultsDiv.style.display = "block";
      }

      /* Initialization */
      window.addEventListener("DOMContentLoaded", async () => {
        // Populate CORS select
        const corsSelect = document.getElementById("cors-select");
        if (corsSelect) {
          CORS_LIST.forEach((proxy) => {
            const option = document.createElement("option");
            option.value = proxy;
            option.textContent = proxy.replace(/\/|\?|=/g, "");
            corsSelect.appendChild(option);
          });
          corsSelect.value = CORS;
          corsSelect.addEventListener("change", (e) => {
            CORS = e.target.value;
            const notification = document.createElement("div");
            notification.style.cssText = "position:fixed;top:100px;right:20px;background:rgba(229,9,20,0.95);color:#fff;padding:10px 14px;border-radius:8px;z-index:1000;box-shadow:0 6px 18px rgba(0,0,0,0.3);";
            notification.textContent = `CORS proxy: ${CORS.replace(/\/|\?|=/g, "")}`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 1800);
          });
        }

        // Setup Video.js XHR hook when available
        if (typeof videojs !== "undefined") setupVideoJsXhrHook(); else window.addEventListener("load", setupVideoJsXhrHook);

        // Load TMDb sections (unchanged logic for other series/films)
        try {
          for (const [key] of Object.entries(endpoints)) {
            const items = await fetchList(key);
            const section = document.getElementById(key);
            const carousel = section?.querySelector(".carousel");
            items.forEach((item) => carousel?.appendChild(createCard(item)));
          }

          // Insert a dedicated Hercai card into popularTV (so it's visible on homepage)
          const popularTVSection = document.getElementById("popularTV");
          const popularCarousel = popularTVSection?.querySelector(".carousel");
          if (popularCarousel) {
            const hercaiObj = { id: HERCAI_TMDB_ID, name: "Hercai", poster_path: null, media_type: "tv", isHercaiCustom: true };
            popularCarousel.insertBefore(createCard(hercaiObj), popularCarousel.firstChild);
          }
        } catch (err) {
          console.warn("Errore caricamento sezioni TMDb:", err);
        }

        // Hook search input
        const searchInput = document.getElementById("search");
        if (searchInput) {
          searchInput.addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length < 2) {
              document.getElementById("results").style.display = "none";
              document.getElementById("home").style.display = "block";
              return;
            }
            searchTimeout = setTimeout(() => performSearch(query), 450);
          });
        }
      });
    </script>
  </body>
</html>
